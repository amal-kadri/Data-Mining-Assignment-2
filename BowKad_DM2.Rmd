---
title: 'ECO 395 Homework 2: John Bowman, Amal Kadri'
author: "John Bowman, Amal Kadri"
date: "3/1/2022"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r}
library(tidyverse)
library(ggplot2)
library(rsample)
library(lubridate)
library(caret)
library(modelr)
library(parallel)
library(foreach)
library(readr)
library(data.table)
library(dplyr)
library(tibble)
library(zoo)
library(here)
library(mosaic)
library(gamlr)
library(class)


capmetro = read.csv(here("data", "capmetro_UT.csv"))
saratoga = (SaratogaHouses)
kredit = read.csv(here("data", "german_credit.csv"))
hotel_dev = read.csv(here("data", "hotels_dev.csv"))
hotel_val = read.csv(here("data", "hotels_val.csv"))
```
#1a
```{r setup, include=True}
knitr::opts_chunk$set(echo = FALSE)

capmetro = read.csv(here("data", "capmetro_UT.csv"))
capmetro = capmetro %>%
  mutate(date_time = ymd_hms(timestamp))

capmetro = capmetro %>% 
  mutate(Timestamp = timestamp)%>%
  separate(timestamp, c("Date","Time")  ,sep = " ")

capmetro$day_of_week = factor(capmetro$day_of_week, levels = c("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"))

avg_board = capmetro %>% 
  group_by(hour_of_day, day_of_week, month) %>% 
  summarize(avg_pass = mean(boarding)) %>% 
  arrange(hour_of_day, day_of_week, month)
view(capmetro)

avg_board

ggplot(avg_board) +
  geom_line(aes(x = hour_of_day, y = avg_pass, col = month)) + 
  facet_wrap(~day_of_week)
  
```

#1b
```{r setup, include=True}

knitr::opts_chunk$set(echo = FALSE)

temp_board = capmetro %>%
  group_by(hour_of_day) %>%
  summarise(mean = mean(boarding))


ggplot(capmetro) +
  geom_point(aes(x=temperature, y = boarding, col = weekend), size = .05) +
  facet_wrap(~hour_of_day)
#fuck with dotsize and label this shiut
```

#Number 2
```{r}
saratoga = (SaratogaHouses)

head(saratoga)
saratoga$centralAir = ifelse(saratoga$centralAir == "Yes",1,0)
saratoga$centralAir = as.numeric(saratoga$centralAir)
houseX = model.matrix(price~(.- pctCollege - sewer - waterfront - landValue - newConstruction -heating - fuel- sewer)^2, data = saratoga)[,-1] 
class(saratoga$centralAir)
houseY = saratoga$price

houseLasso = gamlr(houseX, houseY, alpha = 1)
plot(houseLasso)
lambdamin = which.min(AICc(houseLasso))
houseCoef = coef(houseLasso)
houseCoef
coefData = houseCoef %>% 
  as.matrix() %>%
  as.data.frame()
coefData$magnitude = round(abs(coefData$seg100),2)
coefData
coefData = coefData %>%
  filter(magnitude > 0)
coef_vector = coefData %>% cbind(newColName = rownames(coefs), coefs) %>%
  as.vector(coefData[2:nrow(coefData),1])
```


```{r}
coef_vextor = coef_vextor %>%
  filter(magnitude > 0)
coef_vextor = round(abs(coef_vector$seg100),2)
coef_vector
cbind(newColName = rownames(coefs), coefs) %>%
  as.vector(coefs_fields[2:nrow(coefs_fields),1])
coef_vector
houseCoef = coef(houseLasso)
houseCoef
coefData = as.data.frame(as.matrix(houseCoef))
coefData
coefData$magnitude = round(abs(coefData$seg100),2)
coefData
coefs = coefData %>%
  filter(magnitude>0)
coefs
coefs_fields = cbind(newColName = rownames(coefs), coefs)
coefs_fields
coef_vector = as.vector(coefs_fields[2:nrow(coefs_fields),1])
coef_vector
f <- as.formula(
  paste("price", 
        paste(coef_vector, collapse = " + "), 
        sep = " ~ "))
saratoga_split = initial_split(saratoga, prop = 0.8)
saratoga_train = training(saratoga_split)
saratoga_test = testing(saratoga_split)

lm2 = lm(price ~ . - pctCollege - sewer - waterfront - landValue - newConstruction, data=saratoga_train)

lmLasso = eval(bquote(lm(.(f), data = saratoga)))

### lm for soft code variables
# lmLasso = lm(price ~ . - pctCollege - sewer - waterfront - landValue - newConstruction
#       + lotSize + livingArea  +  bedrooms+ bathrooms + age + lotSize:age + lotSize:fireplaces 
#       + age:livingArea + age:centralAir + livingArea:fireplaces + livingArea:bathrooms
#       + livingArea:rooms + livingArea:centralAir + bedrooms:fireplaces + fireplaces:centralAir
#       + bathrooms:rooms + bathrooms:centralAir, data = saratoga)


k_grid = c(2:100)
K_folds = 5
houseKNN = crossv_kfold(saratoga_train, k = K_folds)
houseKModel = map(houseKNN$train, ~ knnreg(price ~ lotSize + livingArea 
                                           + bedrooms + bathrooms + age, k= 20,
                                           data = .))
#models = map(houseKNN$train, ~ knnreg(price ~ lotSize, k=100, data = ., use.all=FALSE))

cv_House = foreach(k = k_grid, .combine = 'rbind')%do%{
  houseKModel = map(houseKNN$train, ~ knnreg(price ~ lotSize + livingArea 
                                           + bedrooms + bathrooms + age + sewer
                                           + waterfront + newConstruction, k=k,
                                           data = ., use.all = FALSE))
  houseErr = map2_dbl(houseKModel, houseKNN$test, modelr::rmse)
  c(k=k, err = mean(houseErr), std_err = sd(houseErr)/sqrt(K_folds))
}
#houseMin = round(min(cv_House$err))
houseMinK = as.data.frame(cv_House) %>% arrange(err) %>% select(k) %>% head(1) %>% as.numeric()

minKModel = map(houseKNN$train, ~ knnreg(price ~ lotSize + livingArea 
                                           + bedrooms + bathrooms + age+ sewer
                                           + waterfront + newConstruction, k= houseMinK,
                                           data = .))
rmse(lm2, saratoga_test)
rmse(lmLasso, saratoga_test)
map2_dbl(minKModel, houseKNN$test, modelr::rmse)

##################################################################################
#Re-Lasso


```

#Number 3
```{r}
kredit = read.csv(here("data", "german_credit.csv"))
kredit$Good = ifelse(kredit$history == "good",1,0)
kredit$Poor = ifelse(kredit$history == "poor",1,0)
kredit$Terrible = ifelse(kredit$history == "terrible",1,0)
#view(kredit)
credHistory = kredit%>%
  group_by(history)%>%
  summarise(numDefault = sum(Default), count = n()) %>%
  mutate(default_liklihood = numDefault/count)


ggplot(credHistory)+
  geom_col(aes(x = history, y = default_liklihood))

#glm
kredit_split = initial_split(kredit, prop = 0.8)
kredit_train = training(kredit_split)
kredit_test = testing(kredit_split)
credit_model = glm(Default ~ duration + amount + installment + age + history 
                   + purpose + foreign, family = "binomial", kredit_train)

kredit_test = mutate(.data = kredit_test, yhat = predict(credit_model, kredit_test, type='response'))
kredit_test
# ggplot(kred_test) + 
#   geom_jitter(aes(x=Default, y=yhat), width=0.1, alpha=0.2) + 
#   labs(title="Test-set predicted probabilities", y = "P(spam | x)", x="Spam?") + 
#   stat_summary(aes(x=Default, y=yhat), fun='mean', col='red', size=1)

credPredict = predict(credit_model, data=kredit_test, type="response")
yhat_test = ifelse(credPredict > 0.5, 1, 0)
kredit_test =  mutate(.data = kredit_test, yhat_t = ifelse(yhat > 0.5, 1, 0))
confusion_out_logit = table(y = kredit_test$Default,
                            yhat = kredit_test$yhat_t)

confusion_out_logit

#make ROC curve

```

```{r}
model1 = glm(children ~ market_segment + adults + customer_type + is_repeated_guest, hotel_dev, family = "binomial")
plot(model1)
```

